version: '3.9'

# Docker Compose configuration for Tenneco Project
# Orchestrates Client (Frontend), Admin (CMS Backend), and MongoDB services

services:
  # MongoDB Database Service
  mongodb:
    image: mongo:7.0
    container_name: tenneco-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD:-changeme123}
      MONGO_INITDB_DATABASE: tenneco
    volumes:
      # Persist database data
      - mongodb_data:/data/db
      # Persist MongoDB configuration
      - mongodb_config:/data/configdb
    networks:
      - tenneco-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # Admin Service (Payload CMS Backend)
  admin:
    build:
      context: ../admin
      dockerfile: Dockerfile
      args:
        # Pass build-time environment variables if needed
        NODE_ENV: production
    container_name: tenneco-admin
    restart: unless-stopped
    ports:
      - "3001:3000"  # Map host port 3001 to container port 3000
    environment:
      # Node environment
      NODE_ENV: production

      # Database configuration - uses service name 'mongodb' for Docker networking
      DATABASE_URI: ${DATABASE_URI:-mongodb://admin:changeme123@mongodb:27017/tenneco?authSource=admin}

      # Payload CMS secret (REQUIRED - change in production!)
      PAYLOAD_SECRET: ${PAYLOAD_SECRET:-your-secret-here-change-in-production}

      # Server configuration
      PAYLOAD_PUBLIC_SERVER_URL: ${PAYLOAD_PUBLIC_SERVER_URL:-http://localhost:3001}

      # AWS S3 Configuration (for media storage)
      S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID}
      S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY}
      S3_REGION: ${S3_REGION:-eu-central-1}
      S3_BUCKET: ${S3_BUCKET:-tenneco-test}

      # Optional: CloudFront CDN URL
      S3_CLOUDFRONT_URL: ${S3_CLOUDFRONT_URL}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - tenneco-network
    volumes:
      # Cache node_modules for faster rebuilds (development)
      - admin_node_modules:/app/node_modules
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  # Client Service (Next.js Frontend)
  client:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # Build-time environment variables for Next.js
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://admin:3000/api}
        NEXT_PUBLIC_ENABLE_CMS: ${NEXT_PUBLIC_ENABLE_CMS:-true}
        NEXT_PUBLIC_FALLBACK_TIMEOUT: ${NEXT_PUBLIC_FALLBACK_TIMEOUT:-5000}
        NEXT_PUBLIC_CACHE_DURATION: ${NEXT_PUBLIC_CACHE_DURATION:-300000}
    container_name: tenneco-client
    restart: unless-stopped
    ports:
      - "3000:3000"  # Map host port 3000 to container port 3000
    environment:
      # Runtime environment variables
      NODE_ENV: production

      # API URL - uses service name 'admin' for Docker networking
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://admin:3000/api}
      NEXT_PUBLIC_ENABLE_CMS: ${NEXT_PUBLIC_ENABLE_CMS:-true}
      NEXT_PUBLIC_FALLBACK_TIMEOUT: ${NEXT_PUBLIC_FALLBACK_TIMEOUT:-5000}
      NEXT_PUBLIC_CACHE_DURATION: ${NEXT_PUBLIC_CACHE_DURATION:-300000}
    depends_on:
      admin:
        condition: service_healthy
    networks:
      - tenneco-network
    volumes:
      # Cache node_modules for faster rebuilds (development)
      - client_node_modules:/app/node_modules
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

# Network configuration
networks:
  tenneco-network:
    driver: bridge
    name: tenneco-network

# Volumes for data persistence
volumes:
  # MongoDB data persistence
  mongodb_data:
    driver: local
    name: tenneco_mongodb_data

  mongodb_config:
    driver: local
    name: tenneco_mongodb_config

  # Node modules caching (optional - speeds up development rebuilds)
  admin_node_modules:
    driver: local
    name: tenneco_admin_node_modules

  client_node_modules:
    driver: local
    name: tenneco_client_node_modules
